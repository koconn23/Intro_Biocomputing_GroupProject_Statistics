---
title: "Statistics Group Project Using R"
author: "Libby Fortin (efortin@nd.edu), Keith O'Connor (koconn23@nd.edu), Chelsea Weibel (cweibel@nd.edu)"
date: "11/27/2017"
output: html_document
---

### Question 1: Evaluating the effect of three different new antibiotics on growth of E. coli in lab cultures.
##### Let's visualize the data using ggplot. Since the data is categorical we use a boxplot:
```{r}

library(ggplot2)

antibiotics <- read.csv("antibiotics.csv")
      
plot1 <- ggplot(antibiotics, aes(x = trt, y = growth)) +
      geom_boxplot() + 
      theme_bw() + 
      xlab("Antibiotic Type") + ylab("E. coli Growth") +
      theme(plot.title = element_text(hjust = 0.5)) + # Centers the title
      ggtitle("Different Antibiotics on Growth")
                        
plot1

```

#### Next, we need to look at antibiotic treatments on the growth of E. coli using an ANOVA-design linear model and likelihood ratio test. (11/29/17)
##### To do this we first need to assign a value to the absence of antibiotic treatment and the presence of antibiotic treament
+ The easiest way to do this is with a for-loop that assigns a zero to the control treatment, and a one to any of the antibiotic treatments
+ The for-loop below adds a column to the antibiotics dataset called 'aborct' entering zeros and ones to antibiotic treatment or no antibiotic treatment

```{r}
for (i in 1:nrow(antibiotics)){
  if (antibiotics$trt[i] == 'control'){
    antibiotics$aborct[i] <- 0
  }
  else{
    antibiotics$aborct[i] <- 1
  }
}
```

##### Next we need to subset the data into matrices that contain only the control data and one of the antibiotic treatments
+ These matrices are labeled ab1, ab2, and ab3 for the different types of antibiotics
```{r}
ab1 <- antibiotics[antibiotics$trt == 'control',]
ab1[5:8,] <- antibiotics[antibiotics$trt == 'ab1',]
ab2 <- antibiotics[antibiotics$trt == 'control',]
ab2[5:8,] <- antibiotics[antibiotics$trt == 'ab2',]
ab3 <- antibiotics[antibiotics$trt == 'control',]
ab3[5:8,] <- antibiotics[antibiotics$trt == 'ab3',]
```

##### It's easiest to keep our results of the negative log likelihood models and the likelihood ratio test organized if we create a matrix that holds all the results
+ Below we create a matrix where column 1 holds the results of the null model, column 2 holds the results of the linear model, and column 3 holds the results of the likelihood ratio test
```{r}
results <- matrix(0,3,3)
colnames(results) <- c("null", "linear", "chisq")
```

##### Now we are ready to define our negative log likelihood functions, one for the null model and one for the linear model
+ The null model hypothesizes that there is no relationship between antibiotics and growth
+ The linear model hypothesizes that there is a linear relationship between antibiotics and growth
```{r}
#Null model function
nllnull <- function(p,y){
  B0=p[1]
  sig=exp(p[2])
  expected=B0
  nll=-sum(dnorm(x=y, mean=expected, sd=sig,log=TRUE))
  return(nll)
}

#Linear Model function
nlllinear <- function(p,x,y){
  B0=p[1]
  B1=p[2]
  sig=exp(p[3])
  expected=B0+B1*x
  nll=-sum(dnorm(x=y, mean=expected, sd=sig,log=TRUE))
  return(nll)
}
```

##### We are ready to run the null and linear negative log likelihood models for the three different antibiotic treatments and store them in our results table
```{r}
# Antibiotic 1 null model and linear model results
initialGuess <- c(1,1)
fit <- optim(par=initialGuess,fn=nllnull,y=ab1$growth)
results[1,1] <- fit$value

initialGuess <- c(1,1,1)
fit <- optim(par=initialGuess,fn=nlllinear,x=ab1$aborct,y=ab1$growth)
results[1,2] <- fit$value

# Antibiotic 2 null model and linear model results 
initialGuess <- c(1,1)
fit <- optim(par=initialGuess,fn=nllnull,y=ab2$growth)
results[2,1] <- fit$value

initialGuess <- c(1,1,1)
fit <- optim(par=initialGuess,fn=nlllinear,x=ab2$aborct,y=ab2$growth)
results[2,2] <- fit$value

# Antibiotic 3 null model and linear model results
initialGuess <- c(1,1)
fit <- optim(par=initialGuess,fn=nllnull,y=ab3$growth)
results[3,1] <- fit$value

initialGuess <- c(1,1,1)
fit <- optim(par=initialGuess,fn=nlllinear,x=ab3$aborct,y=ab3$growth)
results[3,2] <- fit$value
```

##### Finally we calculate the likelihood ratio test and store the results in our results table
```{r}
#likelihood ratio test results
A <- 2*(results[1,1]-results[1,2])
B <- 2*(results[2,1]-results[2,2])
C <- 2*(results[3,1]-results[3,2])
results[1,3] <- pchisq(q=A, df=1, lower.tail=FALSE) 
results[2,3] <- pchisq(q=B, df=1, lower.tail=FALSE) 
results[3,3] <- pchisq(q=C, df=1, lower.tail=FALSE)
results
```
##### All of the antibiotic treatments have a significant effect on growth because the chi squared values are all less than 0.05!

### Question 2: Evaluating the effect of sugar concentration on growth of E. coli in lab cultures.

```{r}
#### Linear plot of sugar effects on growth with line equation and R2 ####

library(ggplot2)

sugardata <- read.csv(file = "sugar.csv", header=TRUE)

plot2 <- ggplot(data = sugardata, aes(x = sugar, y = growth))+
  geom_point(color = "blue1", shape = 16, size = 2) +
  theme_classic() +
  xlab("Sugar Concentration") + ylab("E. coli Growth") +
  ggtitle("Effect of Sugar Concentration on Growth of E. coli") +
  theme(plot.title = element_text(hjust = 0.5)) + #Centers the title
  stat_smooth(method = "lm", se=FALSE, color="black") + #Adds a trend line, se=FALSE gets rid of cloud around trendline.
  geom_text(aes(x = 5, y = 25, label = lm_eqn1(lm(sugar ~ growth, sugardata))), parse = TRUE) # Adds the values for the R2 value and equation of the trendline to the coordinates x and y

m= lm(sugar ~ growth, sugardata)

lm_eqn1 = function(m) {       #Function to calculate and add R2 value and equation of the trendline to plot
  
  l <- list(a = format(coef(m)[1], digits = 2),
            b = format(abs(coef(m)[2]), digits = 2),
            r2 = format(summary(m)$r.squared, digits = 3));
  
  if (coef(m)[2] >= 0)  {
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2,l)
  } else {
    eq <- substitute(italic(y) == a - b %.% italic(x)*","~~italic(r)^2~"="~r2,l)    
  }
  
  as.character(as.expression(eq));                 
}

plot2

```

#### Next, we need test for an effect of sugar concentration on growth of E. coli using a regression-design linear model and likelihood ratio test. (11/29/17)

```{r}

#### Likelihood ratio test

############## Null model
# Null hypothesis = the growth of E. coli is the same regardless of the sugar concentration

nllnull = function(p,y){
  B0=p[1]
  sig=exp(p[2])
  expected=B0
  nll=-sum(dnorm(x=y, mean=expected, sd=sig,log=TRUE))
  return(nll)
}

initialGuess = c(5,1)
null = optim(par=initialGuess,fn=nllnull,y=sugardata$growth)
print(null)


################ Linear Model
# Alternative hypothesis = the growth of E. coli is dependent on the sugar concentration

nllike_linear=function(p,x,y){
  B0=p[1]
  B1=p[2]
  sigma=exp(p[3])
  
  expected=B0+B1*x
  
  nll_linear=-sum(dnorm(x=y,mean=expected,sd=sigma,log=TRUE))
  return(nll_linear)
}

initialGuess=c(5,1,1)
fit_linear=optim(par=initialGuess,fn=nllike_linear,x=sugardata$sugar,y=sugardata$growth)

print(fit_linear)


############# likelihood ratio test
q = 2*(null$value-fit_linear$value)
lrt = pchisq(q=q, df=1, lower.tail=FALSE)
print(lrt)

# Becuase the p-value is less than 0.05 (2.64e-10), this means that we can reject the null hypothesis and conclude that there is a significant effect of sugar concentration on E. coli growth

```

### Statistical_Power_Analysis

```{r}
#### A statistical power analysis ####
library(ggplot2)

num_sims <- 10 # Simulate the data 10 times 
n_per_sim <- 24 # Each simulation will have 24 values
set.seed(24) # Seed is necessary for reproducibility 
sigma <- c(1,2,4,6,8,12,16,24)

matrix_outputx <- matrix(NA, ncol=n_per_sim, nrow=num_sims) # This creates a 10x24 matrix for the simulated x-values
matrix_outputy <- matrix(NA, ncol=n_per_sim, nrow=num_sims) # This creates a 10x24 matrix for the simulated y-values

for (sim_number in 1:num_sims){ # This starts your for loop
  x <- sample(x = 0:50, size = 24) # Creates a random generation of 24 x-values between 0 and 50 
  m <- 0.4 # Given slope value
  b <- 10 # Given y-intercept
  y <- m*x + b # Calculates y-values from the 24 randomly generated x-values using given slope and intercept 
  
  for (sigma_number in 1:8){
    y = y+rnorm(n_per_sim, sd=sigma)
  }
 
  matrix_outputx[sim_number, ] <- x # This is where each x output is stored for each simulation
  matrix_outputy[sim_number, ] <- y # This is where each y output is stored for each simulation
}
matrix_outputx # Shows the output for the 10 x 24 matrix for the simulated x-values
matrix_outputy # Shows the output for the 10 x 24 matrix for the simulated y-values

#### Linear Regression ####

#### ANOVA ####
```






